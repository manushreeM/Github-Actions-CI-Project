name: Secure CI Pipeline with Docker & Scans

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  secure-ci:
    runs-on: self-hosted

    env:
      IMAGE_NAME: docker.io/${{ secrets.DOCKER_USERNAME }}/secure-app
      IMAGE_TAG: ${{ github.run_number }}

    steps:
    # -------------------------------------------------
    # Checkout
    # -------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # -------------------------------------------------
    # SonarQube Scan
    # -------------------------------------------------
    - name: SonarQube Scan
      continue-on-error: true
      run: |
        docker run --rm \
          -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
          -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
          -v "$PWD:/usr/src" \
          sonarsource/sonar-scanner-cli

    # -------------------------------------------------
    # OWASP Dependency Check (Fast with API key)
    # -------------------------------------------------
    - name: OWASP Dependency Check
      continue-on-error: true
      run: |
        mkdir -p reports/owasp
        docker run --rm \
          -v "$PWD:/src" \
          owasp/dependency-check:latest \
          --scan /src \
          --format HTML \
          --out /src/reports/owasp \
          --nvdApiKey ${{ secrets.NVD_API_KEY }} \
          --disableNodeAudit \
          --disableYarnAudit

    - name: Upload OWASP Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: owasp-report
        path: reports/owasp

    # -------------------------------------------------
    # Install Trivy (Binary – no GPG issues)
    # -------------------------------------------------
    - name: Install Trivy
      run: |
        wget -q https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.tar.gz
        tar -xzf trivy_0.50.1_Linux-64bit.tar.gz
        sudo mv trivy /usr/local/bin/

    # -------------------------------------------------
    # Trivy FS Scan
    # -------------------------------------------------
    - name: Trivy File System Scan
      continue-on-error: true
      run: |
        mkdir -p reports/trivy-fs
        trivy fs . \
          --severity HIGH,CRITICAL \
          --format template \
          --template "@contrib/html.tpl" \
          --output reports/trivy-fs/trivy-fs-report.html

    - name: Upload Trivy FS Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-fs-report
        path: reports/trivy-fs

    # -------------------------------------------------
    # Docker Build
    # -------------------------------------------------
    - name: Docker Build
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .

    # -------------------------------------------------
    # Trivy Image Scan
    # -------------------------------------------------
    - name: Trivy Image Scan
      continue-on-error: true
      run: |
        mkdir -p reports/trivy-image
        trivy image $IMAGE_NAME:$IMAGE_TAG \
          --severity HIGH,CRITICAL \
          --format template \
          --template "@contrib/html.tpl" \
          --output reports/trivy-image/trivy-image-report.html

    - name: Upload Trivy Image Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-image-report
        path: reports/trivy-image

    # -------------------------------------------------
    # Docker Login & Push
    # -------------------------------------------------
    - name: Docker Login
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Docker Push
      run: |
        docker push $IMAGE_NAME:$IMAGE_TAG

    # -------------------------------------------------
    # Email Notification (SUCCESS / FAILURE)
    # -------------------------------------------------
    - name: Send Email Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        secure: false
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_APP_PASSWORD }}
        from: GitHub CI <${{ secrets.GMAIL_USERNAME }}>
        to: vijayakumarbl276@gmail.com
        subject: "CI Security Pipeline Result – ${{ job.status }}"
        body: |
          Hi Vijay,

          CI Pipeline Status: ${{ job.status }}

          Executed stages:
          ✔ SonarQube Scan
          ✔ OWASP Dependency Check
          ✔ Trivy FS Scan
          ✔ Docker Image Build
          ✔ Trivy Image Scan
          ✔ Docker Image Push

          Reports are attached as GitHub artifacts.

          Regards,
          GitHub Actions CI
